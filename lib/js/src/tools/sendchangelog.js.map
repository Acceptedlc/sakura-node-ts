{"version":3,"sources":["../src/tools/sendchangelog.ts"],"names":[],"mappings":";;;;;;;;;AAGA,qCAAqC;AACrC,6BAA6B;AAC7B,yBAAyB;AACzB,6BAAqC;AAKrC;;QAEE,IAAI,WAAW,GAAuB,SAAS,CAAC;QAEhD,MAAM,eAAe,GAAW,6BAA6B,CAAC;QAC9D,EAAE,CAAC,CAAC,EAAE,CAAC,UAAU,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC;YACnC,WAAW,GAAG,EAAE,CAAC,YAAY,CAAC,eAAe,EAAE,MAAM,CAAC,CAAC;QACzD,CAAC;QAED,MAAM,WAAW,GAAQ,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,gBAAgB,CAAC,CAAC,CAAC;QACjE,MAAM,cAAc,GAAW,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;QAE3D,OAAO,CAAC,GAAG,CAAC,sBAAsB,cAAc,qBAAqB,WAAW,EAAE,CAAC,CAAC;QAEpF,EAAE,CAAC,CAAC,cAAc,KAAK,WAAW,CAAC,CAAC,CAAC;YACnC,MAAM,CAAC;QACT,CAAC;QAED,EAAE,CAAC,aAAa,CAAC,eAAe,EAAE,WAAW,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;QAG/D,MAAM,SAAS,GAAuB,IAAI,QAAQ,CAAC,SAAS,EAAE,CAAC;QAC/D,MAAM,gBAAgB,GAAW,IAAI,CAAC,OAAO,CAAC,gBAAgB,CAAC,CAAC;QAChE,IAAI,mBAAmB,GAAW,EAAE,CAAC,YAAY,CAAC,gBAAgB,EAAE,MAAM,CAAC,CAAC;QAE5E,mBAAmB,GAAG,mBAAmB,CAAC,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;QAC9D,mBAAmB,GAAG,mBAAmB,CAAC,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;QAE9D,MAAM,sBAAsB,GAAW,SAAS,CAAC,QAAQ,CAAC,mBAAmB,CAAC,CAAC;QAI/E,MAAM,WAAW,GAAa,CAAC,yBAAyB,CAAC,CAAC;QAC1D,MAAM,SAAS,GAAW,WAAW,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAEhD,MAAM,OAAO,GAAW,yBAAyB,cAAc,EAAE,CAAC;QAElE,sBAAgB,CAAC,aAAa,CAAC,SAAS,EAAE,QAAQ,EAAE,OAAO,EACzD;;UAEM,sBAAsB;eACjB,CAAC,CAAC,IAAI,CAAC,CAAC,SAAiB;YACpC,OAAO,CAAC,GAAG,CAAC,0BAA0B,SAAS,EAAE,CAAC,CAAC;QACrD,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,KAAU;YAClB,OAAO,CAAC,GAAG,CAAC,8BAA8B,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;QAC7D,CAAC,CAAC,CAAC;IACL,CAAC;CAAA;AAED,yBAAyB,EAAE,CAAC,IAAI,CAAC;IAC/B,OAAO,CAAC,GAAG,CAAC,qCAAqC,CAAC,CAAC;AACrD,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,KAAK;IACb,OAAO,CAAC,GAAG,CAAC,SAAS,KAAK,EAAE,CAAC,CAAC;AAChC,CAAC,CAAC,CAAC","file":"sendchangelog.js","sourcesContent":["// Copyright 2016 Frank Lin (lin.xiaoe.f@gmail.com). All rights reserved.\n// Use of this source code is governed a license that can be found in the LICENSE file.\n\nimport * as Showdown from 'showdown';\nimport * as path from 'path';\nimport * as fs from 'fs';\nimport {BaseEmailService} from 'gcs';\n\n/**\n * 将 CHANGELOG.md 发送给订阅更新邮件的人。\n */\nasync function sendChangeLogToDevelopers() {\n  // 将当前 package.json 中的 version 写入 /tmp/gago-data.version\n  let lastVersion: string | undefined = undefined;\n\n  const versionFilePath: string = '/tmp/sakura-node-ts.version';\n  if (fs.existsSync(versionFilePath)) {\n    lastVersion = fs.readFileSync(versionFilePath, 'utf8');\n  }\n\n  const packageJson: any = require(path.resolve('./package.json'));\n  const currentVersion: string = String(packageJson.version);\n\n  console.log(`Current version is ${currentVersion}, last version is ${lastVersion}`);\n\n  if (currentVersion === lastVersion) { // 如果版本与上一个部署的版本一致则不发送邮件\n    return;\n  }\n\n  fs.writeFileSync(versionFilePath, packageJson.version, 'utf8');\n\n  // 发送 CHANGELOG.md\n  const converter: Showdown.Converter = new Showdown.Converter();\n  const dataSourceMdPath: string = path.resolve('./CHANGELOG.md');\n  let dataSourceMdContent: string = fs.readFileSync(dataSourceMdPath, 'utf8');\n\n  dataSourceMdContent = dataSourceMdContent.replace(/\\(/g, '（');\n  dataSourceMdContent = dataSourceMdContent.replace(/\\)/g, '）');\n\n  const dataSourceMarkdownHtml: string = converter.makeHtml(dataSourceMdContent);\n\n  // 发送邮件给后端团队\n  // const toAddresses: string[] = ['back@gagogroup.com'];\n  const toAddresses: string[] = ['linxiaoyi@gagogroup.com'];\n  const toAddress: string = toAddresses.join(',');\n\n  const subject: string = `sakura-node-ts 更新提示 - ${currentVersion}`;\n\n  BaseEmailService.sendHtmlEmail(toAddress, '佳格数据平台', subject,\n    `<html>\n        <p><strong>此邮件为机器生成，请勿回复</strong></p>\n        ${dataSourceMarkdownHtml}\n       </html>`).then((requestId: string) => {\n    console.log(`Send CHANGELOG success ${requestId}`);\n  }).catch((error: any) => {\n    console.log(`Send CHANGELOG with error: ${error.message}`);\n  });\n}\n\nsendChangeLogToDevelopers().then(() => {\n  console.log(`sendChangeLogToDevelopers successes`);\n}).catch((error) => {\n  console.log(`Error ${error}`);\n});\n"]}